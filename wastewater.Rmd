---
title: "Swiss Covid Wastewater Virus Load Data"
author: Kaspar V.
output:
  html_document:
    df_print: paged
    toc: true
    theme: yeti
    md_extensions: +footnotes
    output_file: docs/index.html
params:
  generate_date: '2023-04-19'

---


```{r libs, echo=FALSE, message=FALSE}
# install.packages(list("readr", "xts", "zoo", "curl", "xml2", "scales", "stringr", "dplyr", "knitr", "rvest"))

library(readr)
library(xts)
library(zoo)
library(curl)
library(xml2)
library(scales)
library(stringr)
library(dplyr)
library(knitr)
library(rvest)
Sys.setenv("VROOM_CONNECTION_SIZE" = 50 * 1024 * 1024)
CSVModelDocs <- 'https://www.covid19.admin.ch/api/data/documentation/models/sources-definitions-wastewaterdailyviralloaddata.md'
CSVSourceWebsite <- 'https://opendata.swiss/de/dataset/covid-19-schweiz/resource/f8602049-4f86-4f02-a957-10791642283a'
```

```{r get_url, echo=FALSE, message=FALSE}
html_form_page <- CSVSourceWebsite %>% read_html()
links <- html_form_page %>% html_elements('a[data-format="CSV"]') %>% html_attr("href")
csvUrl <- links[1]
```

```{r load_data, echo=FALSE, message=FALSE}
# Load the source CSV from remote with readr
date_col <- col_date(format = "%Y-%m-%d")
version_col <- col_datetime(format = "%Y-%m-%d_%H-%M-%S")
data_col_types <-
  cols(geoRegion = col_character(), date = date_col, version = version_col)
data_locale <- locale(date_names = "de")
COVID19Wastewater_vl <-
  read_csv(csvUrl, col_types = data_col_types, locale = data_locale)
localities <- COVID19Wastewater_vl %>% distinct(geoRegion,name,canton,pop)
localities_pop_desc <- localities[order(localities$pop, decreasing=TRUE),]
```


```{r plot_functions, echo=FALSE, message=FALSE}
# create locality time series for geoRegion field
locality_data_ts = function(geoRegion) {
  locality_data = COVID19Wastewater_vl[COVID19Wastewater_vl$geoRegion == geoRegion,]
  return <-
    xts(locality_data$vl_percentile_mean7d, order.by = locality_data$date)
}

# Format number of population
pop_format <- scales::label_comma(accuracy = .1, big.mark = "'", decimal.mark = ".")

plot_locality <- function(geoRegion, name, canton, population) {
  pop <- pop_format(as.double(population))
  plot(
    locality_data_ts(as.character(geoRegion)),
    main = str_interp("${name} ${canton} – ${pop} Pop."),
    xlab = 'Date',
    ylab = 'Percentile mean 7d'
  )
}
```

## Information

This document is a personal throw together to get some personal insight into the COVID-19 wastewater virus load data.  
The original data was published by the Swiss Federal Office of Public Health.

- [Covid-⁠19 – Viruslast im Abwasser – Bundesamt für Gesundheit BAG](https://www.covid19.admin.ch/de/epidemiologic/waste-water)
- [Data source website - opendata.swiss](`r CSVSourceWebsite`)  
- [Data model documentation](`r CSVModelDocs`)
- [Source document (CSV ~5.5MB)](`r csvUrl`)
- [Source of this document (R Markdown)](https://github.com/casaper/swiss_wastewater_covid_virus_load/blob/main/wastewater.Rmd)
- Generated at `r params$generate_date`

```{r plot_localities, echo=FALSE, message=FALSE}
plot_locality(26101, 'Werdhölzli', 'ZH', 471000)
plot_locality(664301, 'Aire', 'GE', 451771)
plot_locality(270101, 'Basel', 'BS', 273075)
plot_locality(558600, 'Lausanne (Vidy)', 'VD', 247824)
plot_locality(35100, 'Region Bern', 'BE', 224557)
plot_locality(102400, 'Buholz (Real)', 'LU', 183511)
plot_locality(170200, 'Cham (Schoenau)', 'ZG', 146942)
plot_locality(23001, 'Winterthur', 'ZH', 140403)
plot_locality(94400, 'Thunersee', 'BE', 124550)
plot_locality(515100, 'Lugano', 'TI', 124000)
plot_locality(296300, 'Ramsen (Bibertal-Hegau)', 'SH', 100338)
plot_locality(253400, 'Zuchwil (Soloth.-Emme)', 'SO', 95793)
plot_locality(73300, 'Biel', 'BE', 85389)
plot_locality(24301, 'Dietikon (Limeco)', 'ZH', 83367)
plot_locality(276600, 'Birs', 'BL', 83312)
plot_locality(663801, 'Satigny/Bois-de-Bay', 'GE', 79577)
plot_locality(400100, 'Aarau', 'AG', 78255)
plot_locality(36200, 'Worblental', 'BE', 71636)
plot_locality(323700, 'Altenrhein', 'SG', 64000)
plot_locality(66700, 'Laupen', 'BE', 62000)
plot_locality(404200, 'Baden', 'AG', 59560)
plot_locality(320401, 'St.Gallen (Hofen)', 'SG', 57031)
plot_locality(293700, 'Neuhausen A/Rhf. (Roeti)', 'SH', 56967)
plot_locality(390101, 'Chur', 'GR', 55000)
plot_locality(420300, 'Lenzburg', 'AG', 54568)
plot_locality(250100, 'Winznau (Zv Olten)', 'SO', 54540)
plot_locality(589000, 'Vevey (Aviron)', 'VD', 53864)
plot_locality(500200, 'Bellinzona (Giubiasco)', 'TI', 53209)
plot_locality(664000, 'Thonex/Villette', 'GE', 51028)
plot_locality(511302, 'Locarno (Foce Maggia)', 'TI', 50781)
plot_locality(160200, 'Glarnerland', 'GL', 49644)
plot_locality(254600, 'Grenchen (Buerenamt)', 'SO', 46563)
plot_locality(412300, 'Brugg', 'AG', 46250)
plot_locality(219600, 'Fribourg (Aele)', 'FR', 44211)
plot_locality(8901, 'Niederglatt (Fischb.-Gl.)', 'ZH', 43596)
plot_locality(588600, 'Montreux/Pierrier', 'VD', 41383)
plot_locality(19801, 'Uster (Jungholz)', 'ZH', 41303)
plot_locality(323100, 'Au (Rosenbergsau)', 'SG', 41281)
plot_locality(32101, 'Aarwangen (Zala)', 'BE', 40845)
plot_locality(645800, 'Neuchatel', 'NE', 40697)
plot_locality(613600, 'Martigny', 'VS', 39643)
plot_locality(19101, 'Dübendorf (Ika Neugut)', 'ZH', 39622)
plot_locality('100000', 'Liechtenstein', 'FL', 39315)
plot_locality(564200, 'Morges', 'VD', 39126)
plot_locality(320302, 'St.Gallen (Au)', 'SG', 37876)
plot_locality(282500, 'Ergolz 2', 'BL', 37565)
plot_locality(670900, 'Delemont (Sede)', 'JU', 36484)
plot_locality(40100, 'Burgdorf', 'BE', 36465)
plot_locality(456600, 'Frauenfeld', 'TG', 36369)
plot_locality(30600, 'Lyss', 'BE', 36358)
plot_locality(572100, 'Gland (Apec)', 'VD', 36034)
plot_locality(626601, 'Sion/Chateauneuf', 'VS', 35632)
plot_locality(5301, 'Bülach', 'ZH', 35612)
plot_locality(428000, 'Zofingen', 'AG', 35577)
plot_locality(593800, 'Yverdon', 'VD', 35462)
plot_locality(642100, 'La-Chaux-de-Fonds', 'NE', 35360)
plot_locality(216100, 'Vuippens (Ais)', 'FR', 34647)
plot_locality(120101, 'Altdorf', 'UR', 33940)
plot_locality(41100, 'Moossee-Urtenenbach', 'BE', 33844)
plot_locality(624801, 'Sierre/Noes', 'VS', 32480)
plot_locality(408200, 'Wohlen', 'AG', 31992)
plot_locality(12101, 'Wetzikon (Flos)', 'ZH', 31419)
plot_locality(494600, 'Weinfelden (Mittelthurgau)', 'TG', 31342)
plot_locality(137200, 'Schwyz', 'SZ', 31164)
plot_locality(427100, 'Aarburg', 'AG', 30884)
plot_locality(321700, 'Steinach (Morgental)', 'SG', 30710)
plot_locality(140100, 'Alpnach (Sarneraatal)', 'OW', 30657)
plot_locality(340200, 'Flawil (Oberglatt)', 'SG', 30378)
plot_locality(201, 'Affoltern am Albis', 'ZH', 30226)
plot_locality(132200, 'Hoefe', 'SZ', 29624)
plot_locality(134400, 'Untermarch', 'SZ', 29470)
plot_locality(526200, 'Mendrisio (Rancate)', 'TI', 29392)
plot_locality(286100, 'Ergolz 1', 'BL', 29168)
plot_locality(106500, 'Rontal', 'LU', 28771)
plot_locality(600200, 'Brig-Glis (Briglina)', 'VS', 28678)
plot_locality(333500, 'Rapperswil-Jona', 'SG', 28168)
plot_locality(59300, 'Interlaken', 'BE', 27945)
plot_locality(640600, 'Colombier (La Saunerie)', 'NE', 27582)
plot_locality(13301, 'Horgen', 'ZH', 26952)
plot_locality(526800, 'Chiasso (Vacallo)', 'TI', 26638)
plot_locality(15601, 'Meilen (Rorguet)', 'ZH', 26447)
plot_locality(342500, 'Wil', 'SG', 26295)
plot_locality(283100, 'Pratteln/Rhein', 'BL', 26286)
plot_locality(572400, 'Nyon', 'VD', 25753)
plot_locality(95600, 'Mittl. Emmental', 'BE', 25733)
plot_locality(416900, 'Kaisten', 'AG', 25354)
plot_locality(277500, 'Birsig', 'BL', 24943)
plot_locality(327100, 'Buchs', 'SG', 24844)
plot_locality(511301, 'Locarno (Foce Ticino)', 'TI', 24516)
plot_locality(279300, 'Zwingen (Laufental-L-Tal)', 'BL', 24357)
plot_locality(414100, 'Reinach', 'AG', 23817)
plot_locality(441600, 'Hefenhofen (Aachtal, Moos)', 'TG', 23074)
plot_locality(406300, 'Bremgarten', 'AG', 22613)
plot_locality(571100, 'Commugny', 'VD', 22575)
plot_locality(150900, 'Stans (Rotzwinkel)', 'NW', 21214)
plot_locality(17401, 'Illnau-Effretikon', 'ZH', 18921)
plot_locality(395501, 'Landquart', 'GR', 17054)
plot_locality(300102, 'Herisau (Bachwis)', 'AR', 16500)
plot_locality(680000, 'Porrentruy (Sepe)', 'JU', 16500)
plot_locality(378802, 'S-chanf (Oberengadin)', 'GR', 15056)
plot_locality(297100, 'Hallau (Klettgau)', 'SH', 14795)
plot_locality(329200, 'Flums (Seez)', 'SG', 12448)
plot_locality(329100, 'Bad Ragaz', 'SG', 12007)
plot_locality(310100, 'Appenzell (Boedeli)', 'AI', 11877)
plot_locality(366101, 'Cazis (Waldau)', 'GR', 10963)
plot_locality(385102, 'Davos (Gadenstatt)', 'GR', 9706)
plot_locality(84300, 'Saanen', 'BE', 9253)
plot_locality(397201, 'Seewis (Vorderes Prättigau)', 'GR', 8003)
plot_locality(358201, 'Schluein (Gruob)', 'GR', 7823)
plot_locality(603102, 'Bagnes-Le Châble', 'VS', 7713)
plot_locality(3001, 'Andelfingen', 'ZH', 7150)
plot_locality(630000, 'Zermatt', 'VS', 5507)
plot_locality(605700, 'Goms', 'VS', 4193)
plot_locality(57600, 'Grindelwald', 'BE', 4153)
plot_locality(140200, 'Engelberg', 'OW', 4053)
plot_locality(376201, 'Scuol (Sot Ruinas)', 'GR', 3473)
plot_locality(356101, 'Poschiavo (Li Geri)', 'GR', 3358)
plot_locality(387101, 'Klosters (Gulfia)', 'GR', 3155)
plot_locality(58400, 'Lauterbrunnen', 'BE', 2553)
plot_locality(392101, 'Arosa', 'GR', 2049)
```

## Available Localities

Sorted by wastewater facility population reach.

```{r list_available_localities, echo=FALSE, message=FALSE}
kable(localities_pop_desc)
```

## Contribute

My knowledge of R is extremely limited.  
I've chunked this document together quickly, and I may have done some ugly things for your R experts taste.

Contributions by someone with more R expertise than myself (likely anyone with R knowledge) are, of course, highly welcome.
